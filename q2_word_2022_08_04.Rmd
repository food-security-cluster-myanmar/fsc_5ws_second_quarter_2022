---
title: "Report on the 5Ws"
subtitle: "Second quarter 2022"
author: "Myanmar Food Security Cluster"
date: "2022-07-21"
output: 
  word_document:
    toc: yes
always_allow_html: true   
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(pander)
library(janitor)
library(fuzzyjoin)
library(scales)
library(magrittr)
library(sf)
library(kableExtra)
library(viridis)
library(skimr)
library(plotly)
library(patchwork)
library(broom)
library(DT)
library(here)
library(tidytext)
library(ggforce)
library(flextable)

theme_set(theme_light())

# disabling scientific notation
options(scipen = 100)

# pander tables all in one row
panderOptions('table.split.table', Inf)

# pander thousands separator
panderOptions("big.mark", ",")

# replace 
opts <- options(knitr.kable.NA = "")

`%out%` <- Negate(`%in%`)

# function for transposing df
transpose_df <- function(df) {
  t_df <- data.table::transpose(df)
  colnames(t_df) <- rownames(df)
  rownames(t_df) <- colnames(df)
  t_df <- t_df %>%
    tibble::rownames_to_column(.data = .) %>%
    tibble::as_tibble(.)
  return(t_df)
}

# function beneficiary summaries
sum_ben <- function(df, column_var){
  
  column_var <- enquo(column_var)
  
  df %>%
    group_by(!!column_var) %>% # must add bang-bang
    summarise(beneficiaries = sum(new_beneficiaries, na.rm = TRUE), 
              .groups = "drop") %>% 
    arrange(desc(beneficiaries)) 
    
}

# function beneficiary summaries, 2 grouped variables
sum_ben2 <- function(df, column_var1, column_var2){
  
  column_var1 <- enquo(column_var1)
  column_var2 <- enquo(column_var2)
  
  df %>%
    group_by(!!column_var1, !!column_var2) %>% # must add bang-bang
    summarise(beneficiaries = sum(new_beneficiaries, na.rm = TRUE), 
              .groups = "drop") 
    
}

# scaling functions 
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}

#mode function 
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

```{r data}

fsc <- read_csv("./data/fsc.csv") 

fsc_2021 <- read_csv("./data/fsc_2021.csv")

pin <- read_csv("./data/fs_pin.csv")

hd_list <- fsc %>% 
  group_by(humanitarian_or_development, activity_red) %>%
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(hd = ifelse(humanitarian_or_development == "Humanitarian" |
                       activity_red == "food distribution", 
                     "Humanitarian", 
                     "Development")) %>% 
  mutate(humanitarian_or_development = 
           ifelse(activity_red == "multi-purpose cash transfer" &
                    humanitarian_or_development == "Development",
                  "Humanitarian", humanitarian_or_development)
         ) %>%
  group_by(hd) %>% 
  summarise_at("beneficiaries", sum) %>%
  mutate(pc = round(beneficiaries / sum(beneficiaries) * 100, digits = 2))

# shapefiles
pcode3_shape <- st_read("./mmr_polbnda_adm3_mimu_250k/mmr_polbnda_adm3_mimu_250k.shp", quiet = TRUE) %>%
  rename(state = ST, 
        admin1_pcode = ST_PCODE,
        township = TS,
        admin3_pcode = TS_PCODE) %>% 
 mutate(admin3_pcode = ifelse(str_detect(township, "Hlaingtharya"), "MMR013008", admin3_pcode))

pcode1_shape <- st_read("./mmr_polbnda2_adm1_mimu_250k/mmr_polbnda2_adm1_mimu_250k.shp", quiet = TRUE) %>% 
 rename(state = ST, 
        admin1_pcode = ST_PCODE) %>% st_as_sf()

```


[Food Security Cluster Myanmar homepage](https://food-security-cluster-myanmar.github.io/)

<br>



## Summary of achievements

Beneficiaries of humanitarian action formed `r round(filter(fsc, humanitarian_or_development == "Humanitarian") %>% {sum(.$new_beneficiaries, na.rm = TRUE)} / sum(fsc$new_beneficiaries, na.rm = TRUE) * 100, digits = 2)`% of the `r sum(fsc$new_beneficiaries) %>% format(big.mark = ",")` beneficiaries in the first quarter of 2022. The remainder were reached through development interventions.

In this report, when beneficiaries are mentioned, the Food Security Cluster is referring to unique beneficiaries or individuals. This is different from a beneficiary frequency which is an instance of a person receiving aid i.e. a person who receives food distributions, a crop, vegetable and seed kit and farmer training would be counted as three beneficiary frequencies, but as only one beneficiary. 

To recall, the Food Security Cluster's strategic objectives for 2022 are:

-   SO1: 556,000 IDPs have equitable access to sufficient, safe and nutritious food (either in-kind or through food assistance).
-   SO2: 2.9 million vulnerable persons (excl. IDPs) have equitable access to sufficient, safe and nutritious food (either in-kind or through food assistance).
-   SO3: Restore, protect and improve livelihoods and resilience for 850,000 persons.

Overall, `r hd_list %>% filter(hd == "Humanitarian") %>% pull(pc)`% of the food security cluster's beneficiaries were from humanitarian activities.

<br>

```{r table-so-humanitarian}
fsc %>%  
  mutate(so = 
           ifelse(activity_red == "multi-purpose cash transfer" &
                    humanitarian_or_development == "Development",
                  "SO3", so),
         humanitarian_or_development = 
           ifelse(activity_red == "multi-purpose cash transfer" &
                    humanitarian_or_development == "Development",
                  "Humanitarian", humanitarian_or_development)
         ) %>%
  filter(humanitarian_or_development == "Humanitarian" | activity_red == "food distribution") %>% 
  group_by(so, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), .groups = "drop") %>% 
  pivot_wider(names_from = quarter, 
              values_from = beneficiaries, 
              values_fill = 0) %>%
  mutate(total = q1 + q2) %>% 
  rename_all(.funs = list(str_to_title)) %>% 
  rename(SO = So) %>%  
  mutate(total_pc = Total / sum(Total)) %>% 
  mutate_at(vars(total_pc), ~ round(.x * 100, digits = 2)) %>% 
  select(SO, Q1, Q2, 
         Total_Jun22 = Total,
         `%_of_total` = total_pc) %>% 
  adorn_totals("row") %>%  
  flextable() %>% 
  set_caption(caption = "2022 humanitarian beneficiaries") %>% 
  theme_zebra()

```

<br>

A total of `r hd_list %>% filter(hd == "Development") %>% pull(pc)`% beneficiaries were from development activities and actors.

<br>


```{r table-so-development}

fsc %>%  
  mutate(so = 
           ifelse(activity_red == "multi-purpose cash transfer" &
                    humanitarian_or_development == "Development",
                  "SO3", so),
         humanitarian_or_development = 
           ifelse(activity_red == "multi-purpose cash transfer" &
                    humanitarian_or_development == "Development",
                  "Humanitarian", humanitarian_or_development)
         ) %>% 
  filter(humanitarian_or_development == "Development" & activity_red != "food distribution") %>% 
  group_by(so, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), .groups = "drop") %>% 
  pivot_wider(names_from = quarter, 
              values_from = beneficiaries, 
              values_fill = 0) %>%
  mutate(total = q1 + q2) %>% 
  rename_all(.funs = list(str_to_title)) %>% 
  rename(SO = So) %>%  
  mutate(total_pc = Total / sum(Total)) %>% 
  mutate_at(vars(total_pc), ~ round(.x * 100, digits = 2)) %>% 
  select(SO, Q1, Q2, 
         Total_Jun22 = Total,
         `%_of_total` = total_pc) %>% 
  adorn_totals("row") %>%  
  flextable() %>% 
  set_caption(caption = "2022 development beneficiaries") %>% 
  theme_zebra()

```

<br>

```{r activity-list}
activity_list <- fsc %>% 
  sum_ben2(quarter, activity_red) %>% 
  group_by(quarter) %>% 
  mutate(pc = round(beneficiaries / sum(beneficiaries) * 100, digits = 2))
```

Activities with significant increases in beneficiaries reached compared to Q1 include food/cash for work/assets, multi-purpose cash transfers and vocational training. New persons reached by farmer field school and farmer training dipped, likely due to the seasonality of the intervention. Not encouragingly, the number of new persons reached by food distributions in Q2 was `r activity_list %>% filter(activity_red == "food distribution" & quarter == "q2") %>% pull(pc)`% , almost the same as Q1 (`r activity_list %>% filter(activity_red == "food distribution" & quarter == "q1") %>% pull(pc)`%). There is a need for increased investment in more sustainable, resilience-based solutions. Myanmar will likely face a prolonged food security crisis.

<br>

```{r table-activity}
fsc %>% 
  group_by(quarter, activity_red) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>%  
  pivot_wider(values_from = beneficiaries, names_from = quarter, values_fill = 0) %>% 
  mutate(`%_change` = round((q2 - q1) / q1 * 100, digits = 2), 
         `%_change` = ifelse(is.infinite(`%_change`), 100, `%_change`), 
         activity_red = ifelse(activity_red %in% 
                                 c("FFS and farmer training",
                                   "IGA and small grants", 
                                   "HEB and fortified rice for acute emergencies"), 
                               activity_red,
                               str_to_sentence(activity_red))) %>% 
  rename(Q1 = q1, Q2 = q2, 
         Activity = activity_red) %>%
  mutate(Total = Q1 + Q2, 
         `%total` = round(Total / sum(Total) * 100, digits = 2)) %>% 
  arrange(desc(Total)) %>% 
  flextable() %>% 
  set_caption(caption = "Beneficiaries by activity, as of 30 June 2022") %>% 
  theme_zebra()


```

<br>

```{r ben-type-list}
ben_type_list <- fsc %>%
  filter(str_detect(activity, "food distribution")) %>% 
  group_by(beneficiary_type) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(pc = round(beneficiaries / sum(beneficiaries) * 100, digits = 2))
```

Food distributions overwhelmingly target persons in host and local communities, this group forms `r ben_type_list %>% filter(beneficiary_type == "Host/local Community") %>% pull(pc)`% of all beneficiaries of food distributions or `r ben_type_list %>% filter(beneficiary_type == "Host/local Community") %>% pull(beneficiaries) %>% format(big.mark = ",")` persons.

<br>

```{r food-distributions-fs-status}

fsc %>% 
  filter(str_detect(activity, "food distribution")) %>% 
  group_by(activity, beneficiary_type) %>% 
  mutate(activity = str_extract(activity, "\\, \\w+$"), 
         activity = str_to_title(str_replace(activity, ", ", ""))) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  pivot_wider(names_from = activity, values_from = beneficiaries, values_fill = 0) %>% 
  adorn_totals(c("row", "col")) %>% 
  flextable() %>% 
  set_caption(caption = "Food distributions by type food insecurity status and beneficiary type") %>% 
  theme_zebra()

```

<br>

45% of beneficiaries were reached by activities where nutrition had been mainstreamed.

<br>

```{r table-nutrition-mainstreaming}
fsc %>% 
  mutate(so = str_to_upper(so)) %>% 
  mutate(was_nutrition_mainstreamed_in_activity = ifelse(is.na(was_nutrition_mainstreamed_in_activity), 
                                                         "No", was_nutrition_mainstreamed_in_activity), 
         was_nutrition_mainstreamed_in_activity = fct_relevel(was_nutrition_mainstreamed_in_activity, levels = c("Yes", "No"))) %>% 
  sum_ben2(so, was_nutrition_mainstreamed_in_activity) %>% 
  pivot_wider(names_from = so, values_from = beneficiaries) %>% 
  mutate(total_beneficiaries = SO1 + SO2 + SO3, 
         `%_beneficiaries` = round(total_beneficiaries / sum(total_beneficiaries) * 100, digits = 2)) %>% 
  flextable() %>% 
  set_caption(caption = "Beneficiaries by status of nutrition mainstreaming") %>% 
  theme_zebra()
  
```

<br><br><br>

## 1. Geographies

A total of `r format(sum(fsc$new_beneficiaries), big.mark = ",")` beneficiaries were reached in the first half of 2022. The plot below shows cumulative beneficiaries over time. 

<br>


```{r cum-ben-area}

fsc %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  ggplot(aes(y = fct_reorder(state, beneficiaries), 
             x = beneficiaries, 
             fill = state)) + 
  geom_col() + 
  geom_text(aes(label = comma(beneficiaries)), 
            hjust = "inward") +
  scale_x_continuous(labels = comma) + 
  labs(fill = "", 
       x = "Beneficiaries", 
       y = "", 
       title = "Beneficiaries reached by state, as of Q2 2022") + 
  theme(legend.position = "none")
  
```
<br><br>

### 1.1 States

```{r state-list}
state_list <- fsc %>% 
  sum_ben2(state, quarter) %>% 
  group_by(quarter) %>% 
  mutate(pc = round(beneficiaries / sum(beneficiaries) * 100, digits = 2))

```

Though new beneficiaries reached remained biased towards Yangon and Rakhine in Q2, figures were less skewed than they were in Q1. Overall `r state_list %>% filter(quarter == "q2" & state %in% c("Yangon", "Rakhine")) %>% summarise_at("pc", sum) %>% pull(pc)`% of beneficiaries in Q2 came from Yangon or Rakhine, whereas it was `r state_list %>% filter(quarter == "q1" & state %in% c("Yangon", "Rakhine")) %>% summarise_at("pc", sum) %>% pull(pc)`% in Q1. Kayah saw the largest quarter-to-quarter increase in number of persons reached.

<br>

```{r facet-state-quarter, fig.height = 6.5}
q1_admin3 <- fsc %>% 
  filter(quarter == "q1") %>% 
  distinct(admin3_pcode) %>% 
  as.list()


fsc %>% 
  group_by(state, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(quarter = recode(quarter, 
                          "q1" = "Quarter_1", 
                          "q2" = "Quarter_2")) %>% 
  ggplot(aes(x = beneficiaries, y = fct_reorder(state, beneficiaries))) + 
  geom_col(aes(fill = state)) + 
  facet_row(vars(quarter), scales = "free_x", space = "free") + 
  scale_x_continuous(labels = number_format(scale = 1 / 1000, suffix = "K")) + 
  guides(fill = "none") +
  geom_text(aes(label = comma(beneficiaries)), hjust = "inward", size = 3.5) + 
  labs(x = "Number of beneficiaries reached", 
       y = "", 
       title = "Beneficiaries reached by quarter") + 
  theme(legend.position = "none",
        strip.text = element_text(size = 10, face = "bold"),
        strip.background = element_rect(fill = "#212121"))
  

```

<br>

A total of `r distinct(fsc, admin3_pcode) %>% nrow()` townships have been reached across `r distinct(fsc, admin1_pcode) %>% nrow()` states/regions as of 30th June 2022.

<br><br>

### 1.2 Townships

```{r top-townships-pc, include=FALSE}
fsc %>% 
  group_by(state, township) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), .groups = "drop") %>% 
  mutate(pc = beneficiaries / sum(beneficiaries)) %>% 
  arrange(desc(pc)) %>% 
  filter(beneficiaries > 150000) %>% 
  {sum(.$pc)}
```

The top 7 townships -- Hlaingtharya East and West, Shwepyithar, North Okkalapa, Buthidaung, Dala and Sittwe -- by total number of beneficiaries reached as of 30th June 2022, are all from Yangon or Rakhine and contained 68% of all beneficiaries. There is, overall, still quite a significant skew in where the food security cluster is reaching its beneficiaries. 

<br>

```{r table-top-townships}
fsc %>% 
  group_by(state, township, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), .groups = "drop") %>% 
  pivot_wider(values_from = beneficiaries, names_from = quarter, 
              values_fill = 0) %>% 
  mutate(total = q1 + q2, 
         pc_total = total / sum(total)) %>% 
  mutate_at(vars(matches("pc")), ~ round(.x * 100, digits = 2)) %>% 
  arrange(desc(pc_total)) %>% 
  filter(pc_total >= 1) %>% 
  select(state, township, Q1 = q1, Q2 = q2, 
         Total_Jun_2022 = total, `%total` = pc_total) %>%
  flextable() %>% 
  set_caption(caption = "Beneficiaries by status of nutrition mainstreaming") %>% 
  theme_zebra() %>% 
  add_footer_lines("Only showing townships with >1% of total beneficiaries")
```

<br>

When comparing the current footprint to that of the first quarter, the most significant new activity was observed in Mandalay, Magway, Kayah and Kayin. 


<br>

```{r maps-ben-quarter, fig.height=9}
fsc %>% 
  filter(quarter == "q1") %>% 
  group_by(admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  right_join(pcode3_shape, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(aes(fill = beneficiaries), size = .1) +
  scale_fill_viridis(direction = -1, trans = "log10", 
                     breaks = c(100, 1000, 10000, 100000, 500000), 
                     labels = comma, 
                     na.value = "gray90") + 
  theme_void() + 
  theme(legend.text = element_text(size = 10), 
        legend.title = element_text(size = 10), 
        legend.key.size = unit(.7, "cm"), 
        plot.background = element_rect(fill = "white", colour = "white")) + 
  labs(title = "Beneficiaries by township, as of 2022-03-31", 
       subtitle = "Townships in grey do not have any partners present", 
       fill = "Beneficiaries") + 
  
fsc %>% 
  # filter(quarter == "q2") %>% 
  group_by(admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  right_join(pcode3_shape, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(aes(fill = beneficiaries), size = .1) +
  scale_fill_viridis(direction = -1, trans = "log10", 
                     breaks = c(100, 1000, 10000, 100000, 500000), 
                     labels = comma, 
                     na.value = "gray90") + 
  theme_void() + 
  theme(legend.text = element_text(size = 10), 
        legend.title = element_text(size = 10), 
        legend.key.size = unit(.7, "cm"), 
        plot.background = element_rect(fill = "white", colour = "white")) + 
  labs(title = "Beneficiaries by township, as of 2022-06-30", 
       subtitle = "Townships in grey do not have any partners present", 
       fill = "Beneficiaries")  

# ggsave("./maps_q1_q2.png", dpi = 300, height = 9, width = 8, units = "in")
  
```

<br>

```{r eval = FALSE}
fsc %>% 
  group_by(state, township, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), .groups = "drop") %>% 
  pivot_wider(values_from = beneficiaries, names_from = quarter, 
              values_fill = 0) %>% 
  filter(q1 == 0 & q2 > 0) %>% 
  count(state)
```


31 new townships were added in the second quarter of 2022. 5 of the new townships were from Ayeyarwady; Magway and Mandalay both added 3; Kayah, Mon, Rakhine and Sagaing each added 2; and Bago, Chin and Kayin added 1.  

<br><br>

### 1.3 Locations

A location refers to either a village, ward, IDP site or industrial zone.

The vast amount of project locations have only one food security activity.

<br>

```{r}
fsc %>% 
  filter(!is.na(location)) %>% 
  group_by(location, township, quarter) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            activities = n_distinct(activity), 
            .groups = "drop") %>% 
  mutate(activities = ifelse(activities >= 3, ">=3", activities), 
         activities = fct_relevel(activities, 
                                  c("1", "2", ">=3")),
         activities = recode(activities, 
                             "1" = "1_activity", 
                             "2" = "2_activities", 
                             ">=3" = ">=3_activities"),) %>% 
  ggplot(aes(x = beneficiaries)) + 
  geom_histogram(binwidth = .1) +
  scale_x_continuous(labels = comma, trans = "log10") + 
  facet_wrap(~ activities) + 
  labs(y = "Number of locations", 
       x = "Beneficiary frequencies by location", 
       title = "Beneficiary frequencies by location, faceted by number of activities") +
  theme(legend.position = "none",
          strip.text = element_text(size = 10, face = "bold"),
          strip.background = element_rect(fill = "#212121"))
```

<br>

The same is true for the number of partners, with the majority of locations having one partner. 

<br>

```{r histogram-locations-by-partner, fig.height=7.5}

fsc %>% 
  filter(!is.na(location)) %>% 
  group_by(location, township) %>%  
  summarise(beneficiaries = sum(beneficiaries), 
            partners = n_distinct(org_code), .groups = "drop") %>%
  mutate(partners = recode(partners, 
                           "1" = "1_partner", 
                           "2" = "2_partners", 
                           "3" = "3_partners", 
                           "4" = "4_partners")) %>% 
  arrange(desc(partners)) %>% 
  ggplot(aes(x = beneficiaries)) +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(labels = comma, trans = "log10") +
  facet_wrap(~ partners) +
  labs(y = "number of locations",
       x = "beneficiaries per location", 
       title = "Histograms of beneficiaries by location",
       subtitle = "Faceted by number of partners per location") + 
  theme(legend.position = "none",
          strip.text = element_text(size = 10, face = "bold"),
          strip.background = element_rect(fill = "#212121"))

```


<br>

Of the 2,197 sites reached, 359 had more than one partner present.  

<br>

```{r}
fsc %>% 
  filter(!is.na(location)) %>% 
  group_by(location, township) %>%  
  summarise(beneficiaries = sum(beneficiaries), 
            partners = n_distinct(org_code), .groups = "drop") %>%
  mutate(partners = recode(partners, 
                           "1" = "1_partner", 
                           "2" = "2_partners", 
                           "3" = "3_partners", 
                           "4" = "4_partners")) %>% 
  group_by(partners) %>% 
  summarise_at("location", n_distinct) %>%  
  flextable() %>% 
  set_caption(caption = "Number of partners by location, as of 30 June 2022") %>% 
  theme_zebra()          

```


<br>

The food security cluster's partners can mostly be found in Yangon, Rakhine and Kachin.

<br>

```{r locations-partners-state}
fsc %>% 
  group_by(state, township, location_type) %>% 
  summarise(partners = n_distinct(org_code)) %>%
  filter(location_type != "Industrial zone") %>% 
  mutate(mean_partners = mean(partners, na.rm = TRUE)) %>% 
  ggplot(aes(x = partners, y = fct_rev(state), fill = location_type)) +
  geom_col() +
  facet_wrap(~ location_type) + 
  scale_fill_manual(values = c("#F1C40F", "#1ABC9C", "#EC7063")) +
  theme(legend.position = "none", 
        strip.text = element_text(size = 10, face = "bold"),
          strip.background = element_rect(fill = "#212121")) + 
  labs(x = "Number of implementing partners", y = "", 
       title = "Number of implementing partners by state and location type")
  
```

<br><br><br>

## 2. Activities

### 2.1 Progress by activity

The first dotted red line shows the end of Q1 and the second shows the end of Q2. The thick line in grey shows the progress in 2021 for the same activity. It should be noted that the 2021 progress lines are just a reference and not meant to be a direct comparison -- the scope of the HRP was much different at the start of 2021 and the response was nationwide until the middle of 2021, there were also fewer partners in 2021 than in 2022. This type of comparison will be more useful next year. 

<br>

```{r progress-facet-lineplot}

act_line_2021 <- fsc_2021 %>% 
  filter(unique_beneficiaries == "Yes") %>%
  mutate(date = date + years(1)) %>% 
  group_by(activity_red) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
  mutate(activity_red = str_replace_all(activity_red, "provision of ", "")) %>% 
  filter(activity_red %out% c("fishery kits", 
                              "community infrastructure and equipment"))

fsc %>% 
  group_by(date, activity_red) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  # rbind(fsc_2021 %>% 
  #         # filter(unique_beneficiaries == "Yes") %>%
  #         group_by(date, activity_red) %>% 
  #         summarise(beneficiaries = sum(beneficiaries))) %>% 
  group_by(activity_red) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
  arrange(activity_red) %>% 
  mutate(activity_red = str_replace_all(activity_red, "provision of ", "")) %>%
  filter(activity_red %out% c("fishery kits", 
                              "community infrastructure and equipment")) %>% 
  ggplot(aes(x = date, y = cum_ben, colour = activity_red)) +
  geom_step(data = act_line_2021, 
            aes(x = date, 
                y = cum_ben), 
            colour = "grey",
            size = 2, 
            alpha = .4) + 
  geom_vline(colour = "red", lty = 2, xintercept = as.numeric(as.Date("2022-06-01")), alpha = .5) +
  geom_vline(colour = "red", lty = 2, xintercept = as.numeric(as.Date("2022-03-01")), alpha = .5) +
  geom_step(size = 1) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  facet_wrap(~ activity_red, scales = "free_y") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 5, angle = 60, hjust = 1, vjust = 1), 
        axis.text.y = element_text(size = 5), 
        strip.text = element_text(size = 6, face = "bold"),
        strip.background = element_rect(fill = "#212121")) + 
  labs(x = "Month", 
       y = "Cumulative beneficiary frequencies", 
       title = "Monthly progress by activity, 2022 Q1 & Q2",
       subtitle = "Figures are in cumulative beneficiary frequencies reached; previous year's progress is in grey") + 
  theme(plot.title = element_text(size = 12)) 
  
# ggsave("activity_facet_line.png", dpi = 300, height = 5, width = 8, units = "in")  

```

<br>

Newly implemented in Q2 of 2022 was the provision of HEB and fortified rice, largely in Chin state. Food distributions continued to be the largest activity, followed by the provision of crop, vegetable and seed kits.

<br><br>

### 2.2 Agricultural and livelihoods activities

```{r}
ag_list <- c("crop, vegetable and seed kits",
             "FFS and farmer training",
             "IGA and small grants",
             "livestock kits")


```
`r filter(fsc, activity_red %in% c(ag_list)) %>% {sum(.$new_beneficiaries)} %>% format(big.mark = ",")` persons were reached through a combinatoin of crop, vegetable and seed kits, FFS and farmer training, IGA and small grants and livestock kits. 

<br>

```{r table-agri-activities}
fsc %>% 
  filter(activity_red %in% c("crop, vegetable and seed kits",
                             "FFS and farmer training",
                             "IGA and small grants",
                             "livestock kits")) %>% 
  group_by(activity_red) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(`%beneficiaries` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  arrange(desc(beneficiaries)) %>% 
  adorn_totals("row") %>% 
  flextable() %>% 
  set_caption(caption = "Beneficiaries reached by agricultural and livelihoods activities") %>% 
  theme_zebra() %>% 
  add_footer_lines("as of 30 June 2022")

```

<br>

The plot below shows the beneficiary frequencies reached. The percentage of beneficiaries reached by agriculture and livelihoods activities (crops, vegetable and seed kits; FFS and farmer training; IGA and small grants; livestock kits) slightly in Q2 2022, compared to Q1.


<br>

```{r barplot-facet-ag-activities}
fsc %>% 
  filter(activity_red %in% c("crop, vegetable and seed kits",
                             "FFS and farmer training",
                             "IGA and small grants",
                             "livestock kits")) %>% 
  group_by(activity_red, quarter) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  group_by(quarter) %>% 
  mutate(`%beneficiaries` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2), 
         quarter = recode(quarter, 
                          "q1" = "Quarter_1", 
                          "q2" = "Quarter_2"), 
         ) %>% 
  ggplot(aes(x = beneficiaries, 
             y = fct_reorder(activity_red, beneficiaries), 
             fill = activity_red)) + 
  geom_col(position = position_dodge(width = .9)) + 
  geom_text(aes(label = comma(beneficiaries)), 
            position = position_dodge(width = .9), 
            hjust = "inward") +
  facet_row(vars(quarter), scales = "free_x", space = "free") + 
  labs(x = "Number of beneficiary frequencies", 
       y = "", 
       fill = "agricultural\nactivity",
       title = "Beneficiary frequencies reached by agriculture and livelihoods activities, by quarter") +
  scale_x_continuous(labels = number_format(scale = 1 / 1000, suffix = "K")) +
  theme(legend.position = "none", 
        strip.text = element_text(size = 10, face = "bold"),
        strip.background = element_rect(fill = "#212121"))

```

<br><br>

### 2.3 Delivery modalities

Only HEB and fortified rice and kitchen garden kits were delivered entirely through in-kind modalities.

<br>

```{r}
fsc %>% 
  filter(!is.na(delivery_modality)) %>% 
  mutate(delivery_modality = case_when(str_detect(delivery_modality, "Hybrid") ~ "Hybrid", 
                                       str_detect(delivery_modality, "Service") ~ "Service delivery", 
                                       TRUE ~ delivery_modality)) %>% 
  group_by(activity_red, delivery_modality) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), 
            .groups = "drop") %>% 
  pivot_wider(names_from = delivery_modality, values_from = beneficiaries) %>% 
  adorn_percentages("row") %>% 
  adorn_pct_formatting() %>% 
  left_join(fsc %>%
          filter(!is.na(delivery_modality)) %>%
          mutate(delivery_modality = case_when(str_detect(delivery_modality, "Hybrid") ~ "Hybrid", 
                                       str_detect(delivery_modality, "Service") ~ "Service delivery", 
                                       TRUE ~ delivery_modality)) %>%
          group_by(activity_red) %>%
          summarise(Beneficiaries = sum(new_beneficiaries), 
                    .groups = "drop"), 
          by = "activity_red") %>%
  arrange(desc(Beneficiaries)) %>%
  mutate(activity_red = ifelse(activity_red %in% 
                                 c("FFS and farmer training",
                                   "IGA and small grants", 
                                   "HEB and fortified rice for acute emergencies"), 
                               activity_red,
                               str_to_sentence(activity_red))) %>% 
  rename(Activity = activity_red) %>% 
  mutate_at(vars(`In-kind`, `Service delivery`, `CBT/CVA`, `Hybrid`), 
            ~recode(., "-" = NA_character_)) %>% 
  flextable() %>% 
  set_caption(caption = "Percentage of beneficiaries reached by activity and delivery modality") %>% 
  theme_zebra() %>% 
  add_footer_lines("as of 30 June 2022")

  
```

<br>

There are also clear differences between the different beneficiary types and the delivery modalities employed with them. Beneficiaries from host/local communities largely received in-kind distributions whilst those from camps and IDP sites mostly received cash-based interventions, indicating that partners mostly worked in the same areas in Q1 and Q2. 

<br>

```{r facet-ben-type, fig.height=6}

fsc %>%  
   mutate(delivery_modality = case_when(str_detect(delivery_modality, "Hybrid") ~ "Hybrid", 
                                       str_detect(delivery_modality, "Service") ~ "Service delivery", 
                                       TRUE ~ delivery_modality)) %>% 
  filter(!is.na(delivery_modality) & !is.na(location_type)) %>% 
  sum_ben2(delivery_modality, location_type) %>% 
  ggplot(aes(x = delivery_modality, y = beneficiaries, fill = delivery_modality)) +
  geom_col() + 
  scale_y_continuous(labels = comma) + 
  facet_wrap(~location_type, scales = "free") + 
  theme(axis.text.x = element_text(angle = 25, vjust = .7, hjust = .5),
        legend.position = "none",
        strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121")) +
  labs(x = "Delivery modality", y = "Beneficiaries",
       title = "Delivery modalities by beneficiary type")
  

```

<br>

Areas with the highest number of IDPs, such as Sagaing, Rakhine and Kachin, reach most of their beneficiaries through cash-based programming.

<br>

```{r delivery-modalities-stacked-bar}
state_totals <- fsc %>% 
  filter(!is.na(delivery_modality)) %>% 
  group_by(state) %>% 
  summarise(total = sum(new_beneficiaries)) %>% 
  mutate(pc = 1, 
         state = fct_reorder(state, total))

fsc %>%  
  filter(!is.na(delivery_modality)) %>%  
   mutate(delivery_modality = case_when(str_detect(delivery_modality, "Hybrid") ~ "Hybrid", 
                                       str_detect(delivery_modality, "Service") ~ "Service delivery", 
                                       TRUE ~ delivery_modality)) %>%
  group_by(state, delivery_modality) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  group_by(state) %>% 
  mutate(pc = beneficiaries / sum(beneficiaries),
         state = fct_reorder(state, beneficiaries)) %>% 
  ggplot(aes(x = pc, y = fct_rev(state), fill = delivery_modality)) + 
  geom_col() +
  scale_x_continuous(labels = percent, breaks = seq(0, 1, by = .2)) + 
  geom_text(aes(y = state, x = pc + 0.125, label = comma(total, accuracy = 1), fill = NULL), 
            data = state_totals, hjust = "inward", size = 2.5) +
  labs(x = "% of total", y = "", fill = "", 
       title = "Percentage of beneficiaries reached by delivery modalities", 
       subtitle = "Beneficiaries as of 30 June 2022 at the end of each bar")

```

<br><br><br>

## 3. Cash-based programming

### 3.1 USD per household

Compared to Q1, beneficiaries in Q2 are much less likely to have received cash transfers of less than USD 10 per household. The most common transfer values were between USD 60 and 70, an increase from the previous quarter.

<br>

```{r usd-hhd-bin-barplot, fig.height=5}

fsc %>%
  filter(!is.na(usd_per_hhd) & !is.na(new_beneficiaries)) %>% 
  filter(delivery_modality %in% c("CBT/CVA", "Hybrid (In-kind & CBT/CVA)")) %>%
  group_by(usd_hhd_bin, quarter) %>% 
  summarise(households = sum(households)) %>% 
  group_by(quarter) %>% 
  mutate(`%_of_hhd` = round(households / sum(households) * 100, digits = 2)) %>% 
  ungroup() %>% 
  mutate(quarter = recode(quarter,
                          "q1" = "Quarter_1", 
                          "q2" = "Quarter_2")) %>%  
  mutate(usd_hhd_bin = fct_relevel(usd_hhd_bin, c("<$10", ">=$10_<$20", ">=$20_<$30", ">=$30_<$40", ">=$40_<$50",">=$50_<$60", 
                                                  ">=$60_<$70", ">=$70_<$80", ">=$80_<$90",">=$90_<$100",">=$100"))) %>% 
  ggplot(aes(x = usd_hhd_bin, y = households, fill = usd_hhd_bin)) + 
  geom_col() + 
  geom_text(aes(label = `%_of_hhd`), vjust = -0.4, size = 3) + 
  facet_wrap(~ quarter) + 
  scale_fill_viridis_d(option = "mako", direction = -1) + 
  scale_y_continuous(labels = comma, breaks = seq(0, 80000, by = 10000)) + 
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 60, hjust = 0.8, vjust = 0.9), 
        strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121")) +
  labs(x = "USD value of cash transfer per household per month",
       y = "Number of households",
       title = "Number of households by value of cash transfer per household (2022/Q1)",
       subtitle = "Figures at the top of each bar show percentage of households\nOnly households reached through the cash, hybrid or voucher modalities are included")
```

<br><br>

### 3.2 USD per person

The boxplots below shows the range of cash transfer values (all values are per person, to facilitate comparability) by activity. The average for reach activity is marked by the thick line in the middle of each box. The leftmost and rightmost side of each box indicate the 25th and 75th percentile of transfer values, respectively. The length of each box is a gauge for how much variation there is in the transfer values of each activity.

<br>

```{r boxplot-activity-usd-per-person}

fsc %>% filter(!is.na(total_value_usd) & activity_red %out% c("FFS and farmer training", "vocational training")) %>%
  mutate(activity_red = fct_relevel(activity_red, 
                                    c("food distribution",
                                      "food_cash for work_assets", 
                                      "multi-purpose cash transfer", 
                                      "livestock kits",
                                      "crop, vegetable and seed kits",
                                      "IGA and small grants"
                                      ))) %>% 
  ggplot(aes(y = activity_red, x = usd_per_person, colour = activity_red)) + 
  geom_jitter(alpha = .1, aes(size = beneficiaries)) +
  geom_boxplot(alpha = .8, outlier.alpha = .2) + 
  scale_x_continuous(trans = "log10", breaks = c(0, 1, 3, 10, 30, 100, 300, 1000), 
                     labels = dollar_format(accuracy = 1)) +
  theme(legend.position = "none") +
  labs(x = "USD per person", y = "", 
       title = "Boxplots of USD transfer values per person in 2022 (Q1 & Q2)", 
       subtitle = "Thick line in each box is the mean;\n Points are individual distributions, sizes indicate number of beneficiaries")

 
```

<br>

Each of the bubbles represents an individual intervention, with their position along the x-axis showing the USD per person value of the intervention and the size of each bubble indicating the number of beneficiaries reached.

Food distributions tended to have the tightest range of values, which proves that food assistance is quite standardised amongst partners. 

<br>

```{r plotly-transfer-value-scatter, fig.height=6}

fsc %>% 
  filter(!is.na(total_value_usd) & activity_red %out% c("livestock kits", 
                                                        "vocational training", 
                                                        "FFS and farmer training")) %>%
  group_by(state, township, location, org_code, activity_red, quarter) %>% 
  summarise(beneficiaries = sum(beneficiaries), 
            total_value_usd = sum(total_value_usd), 
            rounds = n_distinct(date), 
            .groups = "drop") %>% 
  mutate(quarter = recode(quarter,
                          "q1" = "Quarter_1", 
                          "q2" = "Quarter_2")) %>% 
  mutate(per_person = round(total_value_usd / beneficiaries, digits = 2)) %>% 
  filter(total_value_usd > 0) %>%
  ggplot(aes(x = beneficiaries, y = per_person, colour = activity_red, 
             text = paste0(org_code, "\n", 
                           activity_red, "\n", 
                           "ben. frequencies: ", comma(beneficiaries, accuracy = 1), "\n",
                           "USD per person: ", dollar(per_person), "\n", 
                           "total value: ", dollar(total_value_usd, accuracy = 1), "\n", 
                           "rounds: ", rounds, "\n", 
                           township, ", ", state))) + 
  geom_jitter(aes(size = total_value_usd), alpha = .5) + 
  scale_y_continuous(trans = "log10", breaks = c(0, 1, 3, 10, 30, 100, 300), labels = dollar_format(accuracy = 1)) + 
  scale_x_continuous(trans = "log10", labels = comma, breaks = c(0, 10, 100, 1000, 10000, 100000, 300000)) + 
  scale_size_continuous(guide = "none", range = c(0.3, 5)) + 
  labs(x = "Beneficiary frequencies", 
       y = "USD value per person", 
       title = "Average USD transfer value per person in 2022 (Q1 & Q2)\nBy organisation, location and activity", 
       subtitle = "By organisation, location and activity", 
       colour = "by org, location and activity\ndouble-click to select") + 
  theme(legend.text = element_text(size = 5),
        legend.title = element_text(size = 5),
        strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121")) + 
  guides(colour = guide_legend(override.aes = list(size = 1, alpha = 1))) + 
  facet_wrap(~ quarter)


```

<br>

Cash transfer values tended to be higher in Q2 as compared to Q1 largely due to increases in the per-household package of multi-purpose cash transfers. This may be explained by the implementation of new 2022 projects that have integrated the inflation in their budgeting. 

<br><br><br>

### 3.3 Food distributions

```{r plotly-food-dist-range}

fsc %>% 
  filter(!is.na(usd_per_person)) %>%
  filter(activity_red == "food distribution" & usd_per_person < 60) %>% 
  ggplot(aes(x = usd_per_person, y = state, colour = state, 
             text = paste0(org_code, "\n", 
                           activity_red, "\n", 
                           "ben. frequencies: ", comma(beneficiaries, accuracy = 1), "\n",
                           "USD per person: ", dollar(usd_per_person), "\n", 
                           "total value: ", dollar(total_value_usd, accuracy = 1), "\n",
                           township, ", ", state))) + 
  geom_vline(xintercept = 11.455, lty = 2, colour = "red", alpha = .5, size = .3) + 
  geom_jitter(alpha = 0.3, aes(size = beneficiaries)) +
  scale_colour_viridis_d() +
  scale_size_continuous(range = c(0.3, 10)) +
  scale_x_continuous(breaks = seq(0, 90, by = 10), labels = dollar_format(accuracy = 1)) +
  labs(x = "USD value per person", 
       y = "", 
       title = "Food distribution: range of USD values per person by state in 2022/Q1",
       size = "", colour = "") 
```

<br>

Kachin, Rakhine and Shan notably have several extreme outliers much higher than the average for that state. Kayin, however, has a very large number of beneficiaries who received less the USD 1/person. Distributions in Chin and Ayeyarwady had very consistent values as they were all implemented by the same implementing partner.

The table below compares the different bins for cash transfer values of food distributions with the minimum expenditure basket for food established by the Cash Working Group. They have established a floor of MMK 190,555 (or USD 114.55) for the food security component per household per month. 

Overall, `r round((filter(fsc, usd_per_person >= (114.55 / 5) & activity_red == "food distribution") %>% {sum(.$new_beneficiaries)}) / (filter(fsc, !is.na(usd_per_person) & activity_red == "food distribution") %>% {sum(.$new_beneficiaries)}) * 100, digits = 2)`% of food distribution beneficiaries have received at least 100% of the food security MEB and `r round((filter(fsc, usd_per_person >= (114.55 / 5 / 2) & activity_red == "food distribution") %>% {sum(.$new_beneficiaries)}) / (filter(fsc, !is.na(usd_per_person) & activity_red == "food distribution") %>% {sum(.$new_beneficiaries)}) * 100, digits = 2)`% have received at least 50% of the food security MEB (USD 11.45 per person).

<br>

```{r table-meb-usd-hhd-bin}

food_bins <- fsc %>% filter(activity_red %in% c("food distribution") & 
                 !is.na(usd_per_person) & 
                 !is.na(new_beneficiaries)) %>% 
  count(usd_person_bin, wt = new_beneficiaries) %>% 
  mutate(pc_of_total = round(n / sum(n) * 100, digits = 2),
         usd_person_bin = fct_relevel(usd_person_bin, c("<$2", ">=$2_<$4", 
                                                        ">=$4_<$6", ">=$6_<$8", 
                                                        ">=$8_<$10",">=$10_<$12",
                                                        ">=$12_<$14", ">=$14_<$16", 
                                                        ">=$16_<$18", ">=$18_<$20",
                                                        ">=20"))) %>% 
  arrange(usd_person_bin)

fsc %>% 
  filter(activity_red %in% c("food distribution") &
                             !is.na(usd_per_person) &
                             !is.na(new_beneficiaries)) %>%
  mutate(pc_meb = usd_per_person * 5 / 114.55, 
         usd_person_bin = fct_relevel(usd_person_bin, c("<$2", ">=$2_<$4", 
                                                        ">=$4_<$6", ">=$6_<$8", 
                                                        ">=$8_<$10",">=$10_<$12",
                                                        ">=$12_<$14", ">=$14_<$16", 
                                                        ">=$16_<$18", ">=$18_<$20",
                                                        ">=20"))) %>% 
  group_by(usd_person_bin) %>% 
  summarise(avg_pc_of_meb = round(mean(pc_meb) * 100, digits = 2),
            avg_usd_month = round(mean(usd_per_person, na.rm = TRUE), digits = 2),
            beneficiaries = round(sum(new_beneficiaries))) %>% 
  mutate(pc_of_hhd = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  flextable() %>% 
  set_caption(caption = "USD values of food distributions by percentage of MEB received") %>% 
  theme_zebra() %>% 
  add_footer_lines("Only persons reached through CBT/CVA/hybrid modalities are included")


```

<br><br>

### 3.4 Implementing partners

```{r partner-cash-values, fig.height=6.5}
partner_mean_usd <- function(tbl, name){

  tbl %>% 
    filter(!is.na(new_beneficiaries) & !is.na(usd_per_hhd)) %>%
    filter(delivery_modality %in% c("CBT/CVA", "Hybrid (In-kind & CBT/CVA)")) %>%
    filter(activity_red == {{name}}) %>%
    mutate(households = ifelse(activity_red == "food distribution", 
                                       beneficiaries, 
                                       households)) %>% 
    group_by(org_code) %>% 
    summarise(total_value_usd = sum(total_value_usd),
              beneficiaries = sum(new_beneficiaries), 
              households = sum(households)) %>% 
    mutate(mean_usd = total_value_usd / households) %>% 
    arrange(desc(beneficiaries)) %>%  
    top_n(7) %>% 
    mutate(org_code = fct_reorder(org_code, beneficiaries)) %>% 
    ggplot(aes(x = beneficiaries, y = org_code, fill = mean_usd)) + 
    scale_x_continuous(labels = comma_format(accuracy = 1)) + 
    scale_fill_viridis(option = "mako", direction = -1, begin = 0.2, 
                       labels = dollar_format(accuracy = 1)) +
    geom_col() +
    geom_text(aes(label = dollar(mean_usd)), size = 3, hjust = "inward") + 
    theme(axis.text.y = element_text(size = 8)) +
  labs(x = "Number of beneficiaries reached", 
       y = "", 
       fill = "Avg USD") +
    theme(legend.title = element_text(size = 7),
          legend.text = element_text(size = 5.5), 
          plot.title = element_text(size = 10),
          axis.title.x = element_text(size = 8))
}

fsc %>% partner_mean_usd("multi-purpose cash transfer") +
  labs(title = "Multi-purpose cash transfer (per hhd)") + 
fsc %>% partner_mean_usd("food distribution") +
  labs(title = "Food distributions (per person)") +
fsc %>% partner_mean_usd("food_cash for work_assets") + 
  labs(title = "Food/cash for work/assets (per hhd)") + 
fsc %>% partner_mean_usd("IGA and small grants") +
  labs(title = "IGA and small grants (per hhd)") + 
  plot_annotation(title = "Cash transfer values of the top implementing partners (by beneficiaries reached)", 
                  subtitle = "Faceted by activity")
###=i-
```

<br><br><br>

## 4. Partners

A total of 61 partners have reported into the Food Security Cluster as of Q2 2022 -- there are 48 implementing partners and 23 reporting partners. 

<br>

```{r barplot-beeneficiary-type}
fsc %>% 
  group_by(date) %>% 
  summarise(implementing = n_distinct(org_code), 
            reporting = n_distinct(report_org_code)) %>% 
  pivot_longer(cols = c(implementing, reporting),
               names_to = "partner", 
               values_to = "count") %>%
  ggplot(aes(x = date, y = count, 
             colour = partner)) + 
  geom_point(size = 2.5) +
  geom_line(size = 1.5) +
  geom_text(aes(label = count), 
            colour = "black", 
            vjust = -.3) +
  scale_x_date(date_labels = "%b-%y") +
  scale_colour_manual(values = c("#F39C12", "#0E6655")) +
  labs(x = "", y = "Number of partners", 
       colour = "Parnter\ntype",
       title = "Number of partners, as of Q2 2022")
```

<br><br>

### 4.1 Implementing partner

There are `r fsc %>% filter(quarter == "q2") %>% distinct(org_code) %>% nrow()` partners that were involved in direct implementation that have reported achievements in second quarter of 2022, in comparison with `r fsc %>% filter(quarter == "q1") %>% distinct(org_code) %>% nrow()`in the first quarter. These implementing partners corresponded to a total of `r fsc %>%  distinct(report_org_code) %>% nrow()` reporting organisations. The largest reporting organisation, 2690, had 24 implementing partners.

<br>

```{r table-reporting-orgs}
fsc %>% group_by(report_org_code) %>% 
  summarise(count = n_distinct(org_code)) %>% 
  arrange(desc(count)) %>% 
  rename(implementing_partners = count) %>% 
  filter(implementing_partners > 2) %>%
  flextable() %>% 
  set_caption(caption = "Reporting organisations with the most implementing partners") %>% 
  theme_zebra() %>% 
  add_footer_lines("All others had 1 or 2 implementing partners")

```

<br>

The interactive plot below shows the number of beneficiaries and townships reached by implementing partner.

`r fsc %>% group_by(org_code) %>% summarise(townships = n_distinct(admin3_pcode)) %>% filter(townships > 5) %>% nrow()` partners (21% of the total) have a presence in more than 5 townships. `r fsc %>% group_by(org_code) %>% summarise(townships = n_distinct(admin3_pcode)) %>% filter(townships > 10) %>% nrow()` partners (16% of the total) are present in more than 10 townships.

<br>

```{r plotly-partner-scatter}

# Median values are x = 5671 and y = 3. Currently using mean. 
fsc %>%  
  group_by(org_code) %>% 
  summarise(states = n_distinct(state), 
            townships = n_distinct(admin3_pcode), 
            beneficiaries = sum(new_beneficiaries)) %>% 
  ggplot(aes(x = beneficiaries, y = townships, 
             text = paste0(org_code, "\n", 
                           "states: ", states, "\n", 
                           "townships: ", townships, "\n", 
                           "beneficiaries: ", comma(beneficiaries, accuracy = 1)))) + 
  geom_vline(xintercept = 48145.33, lty = 2, colour = "red") + 
  geom_hline(yintercept = 4.555556, lty = 2, colour = "red") + 
  geom_point(aes(size = beneficiaries), alpha = .7) + 
  scale_x_continuous(trans = "log", labels = comma, breaks = c(0, 100, 300, 1000, 3000, 10000, 30000, 100000, 300000)) +
  scale_y_continuous(breaks = seq(0, 25, 5)) +
  labs(x = "Number of beneficiaries",
       y = "Number of townships",
       title = "Plot of beneficiaries and townships reached, by implementing partner") +
  theme(legend.position = "none")

# Make a comparison with Q1
```

<br><br>

### 4.2 Monthly progress by partner

Organisations 6197, 2690 and 5722 have implemented the majority of their activities in the second quarter of 2022. 

The thick grey line shows an organisation's progress from last year, which, as mentioned, cannot exactly be used for a straight comparison as the scope of the HRP in 2021 was different until the approval of the IERP, additionally, many partners only joined the cluster in 2022. Still, it serves as a reference. 

<br>

```{r partner-progress-facet-line}

partner_top <- fsc %>% 
  sum_ben(org_code) %>% arrange(desc(beneficiaries)) %>%  mutate(org_code = reorder(org_code, -beneficiaries)) %>% pull(org_code) %>% head(12)

line_2021 <- fsc_2021 %>% 
  filter(unique_beneficiaries == "Yes") %>%
  filter(org_code %in% partner_top) %>% 
  select(date, org_code, beneficiaries, location, admin3_pcode) %>% 
  mutate(date = date + years(1)) %>% 
  group_by(location, admin3_pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  group_by(org_code) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries))

fsc %>%
  filter(org_code %in% partner_top) %>%
  select(date, org_code, beneficiaries = new_beneficiaries, location, admin3_pcode) %>% 
  # rbind(fsc_2021 %>% 
  #         filter(unique_beneficiaries == "Yes") %>% 
  #         filter(org_code %in% partner_top) %>% 
  #         select(date, org_code, beneficiaries, location, admin3_pcode)) %>% 
  group_by(location, admin3_pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  group_by(org_code) %>% 
  arrange(date) %>% 
  mutate(cum_ben = cumsum(beneficiaries)) %>% 
  ggplot(aes(x = date, y = cum_ben)) +
  geom_step(data = line_2021, 
            aes(x = date, 
                y = cum_ben), 
            colour = "grey",
            size = 2, 
            alpha = .4) + 
  geom_vline(colour = "red", lty = 2, xintercept = as.numeric(as.Date("2022-06-01")), alpha = .5) +
  geom_vline(colour = "red", lty = 2, xintercept = as.numeric(as.Date("2022-03-01")), alpha = .5) +
  geom_step(size = 0.7) + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(labels = comma) +
  facet_wrap(~ fct_rev(fct_reorder(org_code, cum_ben, max)), scales = "free_y") +
  theme(legend.position = "none",
        axis.text.x = element_text(size = 5, angle = 60, hjust = 1, vjust = 1),
        axis.text.y = element_text(size = 5),
        strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121"),
        plot.title = element_text(size = 11)) + # see if this works when you knit, then do it for the other plots 
  labs(x = "Month", 
       y = "Cumulative beneficiaries", 
       title = "Monthly progress of top 12 implementing partners, 2022 Q1 & Q2", 
       subtitle = "Figures show cumulative unique beneficiaries; previous year's progress in grey") 

# ggsave("partner_facet_line.png", dpi = 300, height = 5, width = 8, units = "in")  
```

<br>

The table below lists the top 15 partners by number of beneficiaries reached in 2022.

<br>

```{r}
fsc %>%
  group_by(location, admin3_pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  group_by(org_code, quarter) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>%
  pivot_wider(names_from = quarter, values_from = beneficiaries, names_prefix = "ben_") %>% 
  rowwise() %>% 
  mutate(total_ben = sum(ben_q1, ben_q2, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(rank_q1 = dense_rank(-ben_q1), 
         rank_q2 = dense_rank(-ben_q2)) %>% 
  arrange(desc(total_ben)) %>% 
  select(org_code, ben_q1, rank_q1, ben_q2, rank_q2, total_ben) %>% 
  head(15) %>% 
  flextable() %>% 
  set_caption(caption = "Top implementing partners by beneficiaries reached in 2022, as of 30 June 2022") %>% 
  theme_zebra()  
```

<br><br>

### 4.3 Donors

The table below summarises the reach and scope (in terms of geographic extent and number of organisations supported) of donors who support at least two reporting organisations.

<br>

```{r}
fsc %>% 
  group_by(donor) %>% 
  summarise(report_orgs = n_distinct(report_org_code), 
            implementing_orgs = n_distinct(org_code), 
            states = n_distinct(admin1_pcode), 
            townships = n_distinct(admin3_pcode)) %>% 
  filter(!is.na(donor) & report_orgs > 1) %>% 
  arrange(desc(report_orgs)) %>%
  head(15) %>% 
  flextable() %>% 
  set_caption(caption = "Organisations supported and geographic reach by donor") %>% 
  theme_zebra() %>% 
  add_footer_lines("Only showing donors supporting more than one reporting partner")

 
```

<br>

Sagaing, Shan (East) and Ayeyarwady have the fewest number of donors present.

<br>

```{r table-donor-states}
fsc %>% 
  group_by(state) %>% 
  summarise(donors = n_distinct(donor), 
            implementing_partners = n_distinct(org_code)) %>% 
  arrange(desc(donors)) %>% 
  flextable() %>% 
  set_caption(caption = "Number of donors by state") %>% 
  theme_zebra() 

```

<br>

However, as shown by the table below, even though the majority of partners reported their donors, the omission of data from three key partners has resulted in the vast majority of reported beneficiaries not being associated with any donor.

<br>

```{r table-donors-beneficiaries}
fsc %>% 
  group_by(donor) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(donor = ifelse(is.na(donor), "No donor specified", donor), 
         donor = ifelse(beneficiaries < 1000, "Other donors", donor)) %>% 
  group_by(donor) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  mutate(`%_beneficiaries` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  arrange(desc(`%_beneficiaries`)) %>% 
  head(15) %>% 
  flextable() %>% 
  set_caption(caption = "Top donors by beneficiaries reached") %>% 
  theme_zebra() 

 
```

<br>

Below is a table of beneficiaries who are missing donors, grouped by state.

<br>

```{r missing-donor}
fsc %>% 
  filter(is.na(donor)) %>% 
  group_by(state) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), 
            partners = n_distinct(org_code)) %>% 
  arrange(desc(beneficiaries)) %>% 
  filter(beneficiaries > 0) %>% 
  flextable() %>% 
  set_caption(caption = "Reported beneficiaries with missing donor data") %>% 
  theme_zebra() 

```

<br><br><br>

## 5. Beneficiaries

`r round((filter(fsc, beneficiary_type == "Host/local Community") %>% {sum(.$new_beneficiaries)}) / (sum(fsc$new_beneficiaries)) * 100, digits = 2)`% of all beneficiaries in the first half of 2022 were from host or local communities. 

<br><br>



```{r}
fsc %>% 
  group_by(beneficiary_type) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>%
  select(beneficiary_type, beneficiaries) %>% 
  ggplot(aes(x = beneficiaries,
             y = fct_reorder(beneficiary_type, beneficiaries), 
             fill = beneficiary_type, 
             group = beneficiary_type)) + 
  geom_col() + 
  geom_text(aes(label = comma(beneficiaries)), 
            hjust = "inward") + 
  scale_x_continuous(labels = comma) +
  labs(y = "", x = "Beneficiaries", 
       title = "Beneficaries reached by beneficiary type") + 
  theme(legend.position = "none")
```
<br><br>

### 5.1 Beneficiary types

In Q2 2022, `r round(filter(fsc, beneficiary_type == "Host/local Community" & quarter == "q2") %>%  {sum(.$new_beneficiaries)} / (filter(fsc, quarter == "q2") %>%  {sum(.$new_beneficiaries)}) * 100, digits = 2)`% of beneficiaries were from host or local communities, in comparison to `r round(filter(fsc, beneficiary_type == "Host/local Community" & quarter == "q1") %>%  {sum(.$new_beneficiaries)} / sum(fsc$new_beneficiaries) * 100, digits = 2)`% for round 1. `r round(filter(fsc, beneficiary_type == "Internally Displaced" & quarter == "q2") %>%  {sum(.$new_beneficiaries)} / filter(fsc, quarter == "q2") %>%  {sum(.$new_beneficiaries)} * 100, digits = 2)`% of beneficiaries in Q2 were IDPs, compared to `r round(filter(fsc, beneficiary_type == "Internally Displaced" & quarter == "q1") %>%  {sum(.$new_beneficiaries)} / filter(fsc, quarter == "q1") %>%  {sum(.$new_beneficiaries)} * 100, digits = 2)`% for Q1.

<br>

```{r}
fsc %>% 
  group_by(beneficiary_type, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries), 
            .groups = "drop") %>% 
  mutate(beneficiary_type = fct_reorder(beneficiary_type, beneficiaries), 
         quarter = recode(quarter, 
                          "q1" = "Quarter_1", 
                          "q2" = "Quarter_2")) %>% 
  ggplot(aes(y = beneficiary_type, x = beneficiaries, fill = fct_rev(beneficiary_type))) + 
  geom_col() +
  geom_text(aes(label = comma(beneficiaries)), size = 3, vjust = -0.5, 
            hjust = "inward") +
  scale_x_continuous(labels = number_format(scale = 1 / 1000, suffix = "K")) +
  scale_fill_discrete(guide = "none") +
  facet_row(vars(quarter), scales = "free_x", space = "free") + 
  labs(y = "",
       x = "Number of beneficiaries", 
       title = "Persons reached by beneficiary type in Q1 & Q2 2022") +
  theme(strip.text = element_text(size = 8, face = "bold"),
        strip.background = element_rect(fill = "#212121"))
  

# ggsave("beneficiary_type_q1_2022.png", dpi = 300, height = 5, width = 8, units = "in")
```

<br><br>

### 5.2 Evidence of food insecurity status

Of the food security activities reported, very few provided details about the food insecurity status of beneficiaries. This makes it difficult ot determine whether interventions are truly reaching those most in need.

In general, the food insecurity status of the beneficiaries of multi-purpose cash transfers were much better documented than the statuses of those who received food distributions.

<br>

```{r table-food-insecurity-status}
fsc %>% 
  filter(str_detect(activity, "moderate|severe")) %>% 
  mutate(has_evidence = ifelse(is.na(evidence), "no", "yes"), 
         food_insecurity_status = ifelse(is.na(food_insecurity_status), "NA", food_insecurity_status), 
         food_insecurity_status = fct_relevel(food_insecurity_status, "NA", after = Inf)) %>% 
  group_by(activity, food_insecurity_status) %>%
  summarise(beneficiaries = sum(new_beneficiaries),
            .groups = "drop") %>%
  mutate(activity = str_replace_all(activity, "\\(in kind/voucher/cash\\)", ""), 
         activity = str_replace_all(activity, "\\(MPC\\)", ""), 
         activity = str_replace_all(activity, " , ", ", ")) %>% 
  group_by(activity) %>% 
  mutate(`%_of_group` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  filter(food_insecurity_status == "NA") %>% 
  flextable() %>% 
  set_caption(caption = "Missing food insecurity data of beneficiaries, as of 30 June 2022") %>% 
  theme_zebra() 
  
```

<br>

Evidence of beneficiaries' food insecurity status provided to the cluster include:

<br>

```{r table-fs-evidence}
fsc %>% 
  mutate(evidence = case_when(evidence %in% c("0.97", 
                                              "98% of HH have Acceptable FCS", 
                                              "99% of households have acceptable FCS") ~ 
                                "Acceptable FCS", 
                              evidence %in% c("PDM report", "Post Distribution Monitoring") ~ 
                                "Post-distribution monitoring", 
                              str_detect(evidence, "consumption|intake") ~ "Acceptable FCS", 
                              evidence %in% c("Provision/Support Report", "MDR") ~ 
                                "Regular reporting",
                              is.na(evidence) ~ "No evidence", 
                              TRUE ~ evidence), 
         evidence = fct_relevel(evidence, "No evidence", after = Inf)) %>% 
  group_by(evidence) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  mutate(`%_beneficiaries` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>% 
  arrange(desc(beneficiaries)) %>% 
  flextable() %>% 
  set_caption(caption = "Evidence of food insecurity status, as of 30 June 2022") %>% 
  theme_zebra() 

```

<br>

The general lack of evidence of evidence of beneficiaries' food insecurity status makes it difficult to justify to affected communities and donors that the Food Security Cluster is reaching the most in need. This highlights the need to promote a shared understanding of the response through the development of a common prioritisation tool for food security partners.

<br><br><br>

### 5.3 Beneficiary disaggregation

In this section, a test is applied to determine if the disaggregated numbers of beneficiaries reach have been copied and pasted -- a somewhat common practice that sullies the quality of the data. To do this, the proportions of each disaggregation group by partner have been compared to how close they were to the mean for the entire group. To explain: if partner A reported that 40% of beneficiaries in an activity were adult females, this percentage was then compared to the average percentage of adult females for all other activities reported by that partner. This measure whether or not the same proportions were copied and pasted throughout the 5W form.

It is extremely unlikely that these percentages would be similar across activities as implementing partners worked in an average of `r round(fsc %>% group_by(org_code) %>% summarise(locations = n_distinct(location)) %>% {mean(.$locations)}, digits = 2)` locations.

In the plot below, the closer a value is to 0% on the x-axis, the more likely it is that it was copied and pasted. It is estimated that 73% of beneficiary disaggregation values were copied and pasted.

<br>

```{r}
fsc_disagg <- fsc %>% 
  pivot_longer(cols = c(child_male:elderly_female), names_to = "disagg", values_to = "ben_sub") %>% 
  left_join(tribble(
    ~age, ~sex, ~disagg, ~value, 
    "child", "male", "child_male", 0.162989989,
    "child", "female", "child_female", 0.158900883,
    "adult", "male", "adult_male", 0.271450831,
    "adult", "female", "adult_female", 0.300444585,
    "elderly", "male", "elderly_male", 0.044029423,
    "elderly", "female", "elderly_female", 0.06218429
    ) %>% 
              select(disagg, census_prop = value), by = "disagg") %>%
  filter(ben_sub != 0) %>% 
  mutate(ben_prop = ben_sub / beneficiaries, 
         ben_prop_compare = abs(census_prop - ben_prop) / census_prop,
         same_as_census = ifelse(ben_prop_compare < 0.05, "backfilled", "real"))

fsc_disagg_values <- fsc_disagg %>% 
  filter(new_beneficiaries > 0) %>% 
  group_by(same_as_census) %>% 
  summarise(ben_sub = sum(ben_sub)) %>% 
  adorn_percentages("col") %>%  
  mutate(ben_sub = round(ben_sub * 100, digits = 2))
```


```{r disagg-histogram}
fsc_disagg %>% 
  filter(new_beneficiaries > 0) %>% 
  mutate(pc_disagg = ben_sub / beneficiaries) %>% 
  group_by(org_code, disagg) %>% 
  mutate(mean = mean(pc_disagg), 
            sd = sd(pc_disagg, na.rm = TRUE),
            ben_sub = sum(ben_sub, na.rm = TRUE)) %>% 
  mutate(cat = ifelse(sd >= .05, "real", "fake"), 
         cat = ifelse(is.na(cat), "real", cat)) %>% 
  # group_by(cat) %>% 
  # summarise_at("new_beneficiaries", sum) %>% 
  # mutate(pc  = new_beneficiaries / sum(new_beneficiaries))
  filter(sd <= 1) %>% 
  ggplot(aes(x = sd)) + 
  geom_histogram(binwidth = .02) + 
  geom_vline(xintercept = .05, lty = 2, colour = "red") +
  scale_x_continuous(labels = percent_format(accuracy = 1), 
                     breaks = seq(0, 1, by = .2)) +
  labs(x = "Percentage difference from group mean", 
       title = "Histogram of standard deviations across beneficiary disaggregations", 
       subtitle = "The lower the standard deviation, the more likely the value is to be copy/pasted.\nCut-off is the red line.") 

```

<br>

The plot on the below-left shows the breakdown of beneficiaries by disaggregation group with the copy-pasted values removed. The plot on the below-right shows a breakdown of the "fake" copy-pasted values. 

<br>

```{r barplot-disagg}
fsc_disagg %>% 
  filter(new_beneficiaries > 0) %>% 
  mutate(pc_disagg = ben_sub / beneficiaries) %>% 
  group_by(org_code, disagg) %>% 
  mutate(mean = mean(pc_disagg), 
            sd = sd(pc_disagg, na.rm = TRUE),
            ben_sub = sum(ben_sub, na.rm = TRUE)) %>% 
  mutate(cat = ifelse(sd >= .05, "real", "fake"), 
         cat = ifelse(is.na(cat), "real", cat)) %>% 
  filter(cat == "real") %>%
  group_by(disagg) %>% 
  summarise_at("ben_sub", sum) %>% 
  mutate(pc = ben_sub / sum(ben_sub), 
         disagg = fct_relevel(disagg, 
                              c("child_male", "child_female", 
                                "adult_male", "adult_female", 
                                "elderly_male", "elderly_female"))) %>%
  ggplot(aes(x = disagg, y = pc, fill = disagg)) + 
  geom_col() + 
  geom_text(aes(label = percent(pc, accuracy = .1)), vjust = -.1) + 
  scale_y_continuous(labels = percent_format(accuracy = 1)) + 
  labs(x = "Disaggregation group", 
       y = "Percentage of all beneficiaries", 
       title = "Real values -- age and sex breakdown") + 
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) + 
  
fsc_disagg %>% 
  filter(new_beneficiaries > 0) %>% 
  mutate(pc_disagg = ben_sub / beneficiaries) %>% 
  group_by(org_code, disagg) %>% 
  mutate(mean = mean(pc_disagg), 
            sd = sd(pc_disagg, na.rm = TRUE),
            ben_sub = sum(ben_sub, na.rm = TRUE)) %>% 
  mutate(cat = ifelse(sd >= .05, "real", "fake"), 
         cat = ifelse(is.na(cat), "real", cat)) %>% 
  filter(cat == "fake") %>%
  group_by(disagg) %>% 
  summarise_at("ben_sub", sum) %>% 
  mutate(pc = ben_sub / sum(ben_sub), 
         disagg = fct_relevel(disagg, 
                              c("child_male", "child_female", 
                                "adult_male", "adult_female", 
                                "elderly_male", "elderly_female"))) %>%
  ggplot(aes(x = disagg, y = pc, fill = disagg)) + 
  geom_col() + 
  geom_text(aes(label = percent(pc, accuracy = .1)), vjust = -.1) + 
  scale_y_continuous(labels = percent_format(accuracy = 1)) + 
  labs(x = "Disaggregation group", 
       y = "Percentage of all beneficiaries", 
       title = "Fake values -- age and sex breakdown") +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1)) 

```



<br><br>

### 5.4 Beneficiary frequencies

Across both quarters of 2022, food distributions formed the vast majority of humanitarian activity related to food security.  

<br>

```{r}
fsc %>% 
  group_by(activity_red) %>% 
  summarise_at("beneficiaries", sum) %>%  
  ggplot(aes(x = beneficiaries, 
             y = fct_reorder(activity_red, beneficiaries), 
             fill = activity_red)) + 
  geom_col() + 
  geom_text(aes(label = comma(beneficiaries)), hjust = "inward", size = 3.5) +
  scale_x_continuous(labels = comma) + 
  labs(x = "Beneficiary frequencies", 
       y = "", 
       title = "Beneficiary frequencies reached by quarter") +
  theme(legend.position = "none",
        strip.text = element_text(size = 10, face = "bold"),
        strip.background = element_rect(fill = "#212121"))


```
<br>

Below is a summary table of beneficiary frequencies reached by activity. 

<br>

```{r}
fsc %>% 
  group_by(activity_red) %>% 
  summarise_at("beneficiaries", sum) %>%  
  ungroup() %>% 
  mutate(`%_frequencies` = round(beneficiaries / sum(beneficiaries) * 100, digits = 2)) %>%
  rename(activity = activity_red, 
         beneficiary_frequencies = beneficiaries) %>% 
  arrange(desc(beneficiary_frequencies)) %>% 
  flextable() %>% 
  set_caption(caption = "Beneficiary frequencies by activity") %>% 
  theme_zebra()
    

  
```


<br><br><br>


## 6. Comparison with targets

### 6.2 Reached vs target by township

The specifics of each township can be reviewed with the interactive plot below. Each point is a township, with the size indicating the number of beneficiaries. The x-axis indicates the target population by township and the y-axis shows the number of beneficiaries reached, as of Q2 2022.

The red line down the middle represents reaching 100% of the target. Townships above this line have reached more beneficiaries than their target and townships below the line have not met their target yet. The further away a township is from the red line, the further above or below its target it is. Mouse over each of the townships to see more details.

The 13 townships along the extreme left side of the plot have beneficiaries but do not have targets (their targets have just been coded as 1 so that they show up on the plot). 209 townships with targets have not been reached.


<br>

```{r plotly-tsp-comparison-reached-target}

fsc %>% 
  group_by(admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(new_beneficiaries),
            partners = n_distinct(org_code)) %>% 
  left_join(pin, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  mutate(reached_pc = beneficiaries / fs_targeted,
         reached_pc = ifelse(is.infinite(reached_pc), 1, reached_pc),
         fs_targeted = ifelse(fs_targeted == 0 & beneficiaries > 0, 1, fs_targeted),
         fs_targeted = round(fs_targeted, digits = 0)) %>% 
  arrange(desc(reached_pc)) %>% 
  select(state, township, fs_pin, fs_targeted, beneficiaries, reached_pc, partners) %>%
  ggplot(aes(x = fs_targeted, y = beneficiaries, colour = partners, 
             text = paste0(township, ",", "\n",
                           state, ",", "\n",
                           "beneficiaries: ", comma(beneficiaries, accuracy = 1), "\n",
                           "target: ", comma(fs_targeted, accuracy = 1), "\n",
                           "% of target: ", percent(reached_pc, accuracy = 2), "\n", 
                           "partners: ", partners))) + 
  geom_abline(intercept = 0, slope = 1, lty = 2, colour = "red") + 
  geom_point(aes(size = beneficiaries), alpha = 0.8) +
  scale_size_continuous(guide = "none") + 
  scale_x_continuous(trans = "log10", labels = comma) + 
  scale_y_continuous(trans = "log10", labels = comma) +
  scale_colour_viridis(direction = -1, breaks = c(0, 2, 5, 8, 10)) +
  labs(x = "Targeted population", y = "Beneficiaries", 
       title = "Beneficiaries reached vs targeted population by township, Q1 2022",
       subtitle = "The red line is 100% of target") + 
  theme(legend.title = element_text(size = 7))


```


<br>

The table below shows the top townships in terms of overreach. 

<br>

```{r table-overreached-townships}

fsc %>% 
  group_by(admin3_pcode_old, quarter) %>% 
  summarise(beneficiaries = sum(new_beneficiaries)) %>% 
  pivot_wider(names_from = quarter, values_from = beneficiaries, 
              values_fill = 0)  %>% 
  mutate(beneficiaries = q1 + q2) %>% 
  right_join(pin %>% 
               select(state, township, admin3_pcode, 
                      target = fs_targeted), 
             by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  ungroup() %>% 
  mutate(pc = beneficiaries / target, 
         pc = ifelse(is.infinite(pc), 0, pc), 
         gap = target - beneficiaries) %>% 
  arrange(gap) %>% 
  head(15) %>%    
  mutate_at(vars(target, gap), ~ round(.x, digits = 0)) %>% 
  select(state, township, Q1 = q1, Q2 = q2, 
         beneficiaries, target, gap) %>% 
  flextable() %>% 
  set_caption(caption = "Top 15 most overreached townships, as of 30 June 2022") %>% 
  theme_zebra()

  
  
```

<br>

In most of the townships where the food security cluster is present, the number of beneficiaries reached is under the cluster target. Not encouragingly, the fastest growing group of townships are those where the target has been exceeded. 

<br>

```{r}
fsc %>% 
  pivot_wider(names_from = quarter, values_from = new_beneficiaries, 
              values_fill = 0) %>% 
  mutate(total = q1 + q2) %>% 
  left_join(fsc %>% 
              group_by(admin3_pcode = admin3_pcode_old) %>% 
              summarise(beneficiaries = sum(new_beneficiaries))) %>% 
  left_join(pin, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  mutate(reach = case_when(q1 > fs_targeted * 1.1 ~ "overreach", 
                              q1 > fs_targeted * .9 & 
                                q1 <= fs_targeted * 1.1 ~ "on_target", 
                              q1 <= fs_targeted * .9 ~ "under")) %>%
  group_by(reach) %>%
  summarise(townships_Q1 = n_distinct(admin3_pcode)) %>% 
  left_join(
    fsc %>%
      pivot_wider(names_from = quarter, values_from = new_beneficiaries, 
                values_fill = 0) %>% 
    mutate(total = q1 + q2) %>% 
    left_join(fsc %>% 
                group_by(admin3_pcode = admin3_pcode_old) %>% 
                summarise(beneficiaries = sum(new_beneficiaries))) %>% 
    left_join(pin, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
    mutate(reach = case_when(total > fs_targeted * 1.1 ~ "overreach", 
                                total > fs_targeted * .9 & 
                                  total <= fs_targeted * 1.1 ~ "on_target", 
                                total <= fs_targeted * .9 ~ "under")) %>% 
      group_by(reach) %>%
      summarise(townships_Q2 = n_distinct(admin3_pcode)), 
    by = "reach"
  ) %>%  
  mutate(category = fct_relevel(reach, 
                             c("under", 
                               "on_target", 
                               "overreach")), 
         range = case_when(category == "under" ~ "<90% of target", 
                           category == "on_target" ~ ">=90% and < 110% of target", 
                           category == "overreach" ~ ">= 110% of target")) %>% 
  select(category, range, townships_Q1, townships_as_of_Jun2022 = townships_Q2) %>%
  arrange(category) %>% 
  flextable() %>% 
  set_caption(caption = "") %>% 
  theme_zebra()
  
```


<br><br>

### 6.2 Map of beneficiaries reached in Q1 & Q2 2022 vs target

```{r maps-ben-target, fig.height=14}
fsc %>% 
  filter(quarter == "q1") %>% 
  group_by(admin3_pcode = admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  right_join(pcode3_shape, by = c("admin3_pcode")) %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = beneficiaries), size = 0.1) +
  scale_fill_viridis_c(direction = -1, trans = "log10", 
                       breaks = c(100, 1000, 10000, 100000, 500000),
                       labels = comma, 
                       na.value = "gray90") + 
  theme_void() +
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.key.size = unit(0.7, 'cm'), 
        plot.background = element_rect(fill = "white", colour = "white")) +
  labs(title = "Beneficiaries Q1 2022, by township",
       subtitle = "townships in grey do not have any partners present", 
       fill = "Beneficiaries") +
  
fsc %>% 
  group_by(admin3_pcode = admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(beneficiaries)) %>% 
  right_join(pcode3_shape, by = c("admin3_pcode")) %>% 
  st_as_sf() %>% 
  ggplot() +
  geom_sf(aes(fill = beneficiaries), size = 0.1) +
  scale_fill_viridis_c(direction = -1, trans = "log10", 
                       breaks = c(100, 1000, 10000, 100000, 500000),
                       labels = comma, 
                       na.value = "gray90") + 
  theme_void() +
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.key.size = unit(0.7, 'cm'), 
        plot.background = element_rect(fill = "white", colour = "white")) +
  labs(title = "Beneficiaries Total 2022 as of 30 June 2022, by township",
       subtitle = "townships in grey do not have any partners present", 
       fill = "Beneficiaries") +
pin %>% 
  right_join(pcode3_shape, by = "admin3_pcode") %>% 
  st_as_sf() %>%  
  ggplot() + 
  geom_sf(aes(fill = fs_targeted), size = .1) + 
  scale_fill_viridis_c(direction = -1, trans = "log10",  
                       breaks = c(100, 1000, 10000, 100000, 500000),
                       limits = range(57, 801760), 
                       labels = comma, 
                       na.value = "gray90") + 
  theme_void() + 
  theme(legend.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.key.size = unit(0.7, 'cm'), 
        plot.background = element_rect(fill = "white", colour = "white")) +
    labs(title = "Target by township",
         subtitle = "townships in grey do not food security targets", 
         fill = "target") + 
  
pin %>% 
  right_join(pcode3_shape, by = "admin3_pcode") %>%  
  st_as_sf() %>% 
  ggplot() + 
  geom_sf(aes(fill = fs_pin), size = .1) + 
  scale_fill_viridis_c(direction = -1, trans = "log10",  
                       breaks = c(100, 1000, 10000, 100000, 500000),
                       limits = range(57, 801760), 
                       labels = comma, 
                       na.value = "gray90") + 
  theme_void() + 
  theme(legend.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          legend.key.size = unit(0.7, 'cm'), 
        plot.background = element_rect(fill = "white", colour = "white")) +
    labs(title = "People in Need by township",
         subtitle = "townships in grey do not food security targets", 
         fill = "PIN")
  

# ggsave("target_by_tsp.png", dpi = 300, height = 18, width = 11, units = "in")



```

<br><br><br>

### 6.3 Interactive reference table

In the interactive table below, is a list of townships sorted by the gap between the targeted population and beneficiaries reached in 2022. Any of the columns can be sort; the search bars above each column can also assist in filtering.

<br>

```{r}
fsc %>% 
  group_by(admin3_pcode_old) %>% 
  summarise(beneficiaries = sum(new_beneficiaries),
            partners = n_distinct(org_code)) %>% 
  right_join(pin, by = c("admin3_pcode_old" = "admin3_pcode")) %>% 
  replace_na(list(beneficiaries = 0)) %>%
  mutate(reached_pc = beneficiaries / fs_targeted,
         reached_pc = ifelse(is.infinite(reached_pc), 1, reached_pc),
         reached_pc = round(reached_pc * 100, digits = 2), 
         fs_targeted = round(fs_targeted, digits = 0), 
         gap = fs_targeted - beneficiaries) %>% 
  arrange(gap) %>% 
  select(state, township, target = fs_targeted, beneficiaries, 
         gap, `%_reached` = reached_pc, partners) %>% 
  datatable(options = list(pageLength = 15, scrollX = TRUE), 
            filter = list(position = "top", clear = FALSE),
            caption = htmltools::tags$caption(style = 'caption-side: top; 
                                    text-align: center; 
                                    color:black; font-size:120% ;',
                                    "Reference table -- townships")) %>% 
  formatRound(c("target", "beneficiaries", "gap"), digits = 0) %>% 
  formatStyle(0, target = "row", lineHeight = "80%", fontSize = "80%")



```


